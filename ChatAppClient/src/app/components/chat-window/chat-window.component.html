<div class="chat-content" [ngClass]="'theme-' + chatTheme">
  <!-- Header hiển thị thông tin người nhận -->
  <app-chat-header *ngIf="recipientInfo" [recipientInfo]="recipientInfo"></app-chat-header>

  <div class="chat-window" *ngIf="recipientId; else selectChatMessage">
    <div class="chat-messages" #chatMessages>
      <!-- Vòng lặp hiển thị tin nhắn -->
      <div *ngFor="let message of messages; let i = index"
           class="message-wrapper"
           [ngClass]="{'sent': message.userId === currentUserId, 'received': message.userId !== currentUserId}">

        <!-- Hiển thị ngày/giờ nếu có -->
        <div *ngIf="message.displayDate" class="message-time">
          <p>{{ message.displayDate }}</p>
        </div>

        <!-- Tên người gửi trong nhóm chat -->
        <p *ngIf="message.groupId" class="sender-name">{{ message.senderFullName }}</p>

        <!-- Hiển thị tin nhắn được reply -->
        <div *ngIf="message.repliedToMessage" class="replied-message">
          <p class="replied-message-content">
            Replying to: <strong>{{ message.repliedToMessage.senderFullName }}</strong>
            <br/>
            <span [innerHTML]="message.repliedToMessage.message"></span>
          </p>
        </div>

        <!-- Gộp tin nhắn, reaction, delete và reply button vào một thẻ div với display: flex -->
        <div class="message-container">
          <!-- Hiển thị nội dung tin nhắn nếu chưa bị xóa -->
          <div class="message-content" *ngIf="!message.isDeleted && message.message">
            <span [innerHTML]="message.translatedMessage ? message.translatedMessage : message.message"></span>
          </div>

          <!-- Hiển thị thông báo tin nhắn đã bị xóa -->
          <div *ngIf="message.isDeleted" class="message-content deleted-message">
            Message has been deleted
          </div>

          <!-- Hiển thị đính kèm nếu có -->
          <div *ngIf="!message.isDeleted && message.attachmentUrl" class="attachment">
            <ng-container [ngSwitch]="getAttachmentType(message.attachmentUrl)">
              <!-- Đính kèm hình ảnh -->
              <img *ngSwitchCase="'image'" [src]="getAttachmentUrl(message.attachmentUrl)" alt="Image attachment"
                   (click)="openAttachmentPreview(message.attachmentUrl, 'image')" class="attachment-preview-image" />

              <!-- Đính kèm video -->
              <video *ngSwitchCase="'video'" controls [src]="getAttachmentUrl(message.attachmentUrl)"
                     (click)="openAttachmentPreview(message.attachmentUrl, 'video')" class="attachment-preview-video"></video>

              <!-- Đính kèm âm thanh -->
              <audio *ngSwitchCase="'audio'" controls [src]="getAttachmentUrl(message.attachmentUrl)"
                     class="attachment-preview-audio"></audio>

              <!-- Đính kèm PDF -->
              <div *ngSwitchCase="'pdf'" class="attachment-file">
                <i class="fas fa-file-pdf"></i>
                <a [href]="getAttachmentUrl(message.attachmentUrl)" target="_blank">
                  {{ message.attachmentOriginalName }}
                </a>
              </div>

              <!-- Đính kèm DOCX -->
              <div *ngSwitchCase="'docx'" class="attachment-file">
                <i class="fas fa-file-word"></i>
                <a [href]="getAttachmentUrl(message.attachmentUrl)" target="_blank">
                  {{ message.attachmentOriginalName }}
                </a>
              </div>

              <!-- Các loại đính kèm khác -->
              <div *ngSwitchDefault class="attachment-file">
                <i class="fas fa-file-alt"></i>
                <a [href]="getAttachmentUrl(message.attachmentUrl)" target="_blank">
                  {{ message.attachmentOriginalName }}
                </a>
              </div>
            </ng-container>
          </div>

          <!-- Nút xóa tin nhắn, reply và reaction -->
          <div class="actions-container" [ngClass]="{'sent-actions': message.userId === currentUserId, 'received-actions': message.userId !== currentUserId}">
            <!-- Nút xóa tin nhắn -->
            <button *ngIf="!message.isDeleted && message.userId === currentUserId" class="delete-button" (click)="onDeleteMessage(message.id)">
              <i class="fas fa-trash-alt"></i>
            </button>

            <!-- Nút reply message -->
            <button *ngIf="!message.isDeleted" class="reply-button" (click)="onReplyMessage(message)">
              <i class="fas fa-reply"></i>
            </button>

            <!-- Nút reaction -->
            <div *ngIf="!message.isDeleted" class="add-reaction" (click)="toggleReactionPicker(i)">
              <i class="fas fa-smile"></i>
            </div>

            <!-- Nút dịch tin nhắn (chỉ hiển thị nếu chưa bị xóa, chưa dịch và không phải là tin nhắn đính kèm) -->
            <button *ngIf="!message.isDeleted && !message.translatedMessage && !message.attachmentUrl" class="translate-button" (click)="onTranslateMessage(message)">
              <i class="fas fa-language" aria-label="Translate"></i>
            </button>

            <!-- Nút quay lại nội dung gốc (chỉ hiển thị nếu đã dịch, chưa bị xóa và không phải là tin nhắn đính kèm) -->
            <button *ngIf="!message.isDeleted && message.translatedMessage && !message.attachmentUrl" class="original-button" (click)="onShowOriginalMessage(message)">
              <i class="fas fa-undo" aria-label="Show original"></i>
            </button>


          </div>
        </div>

        <!-- Hiển thị reactions nếu có -->
        <div *ngIf="!message.isDeleted && message.Reaction?.$values?.length > 0" class="message-reactions">
        <span class="reaction-group">
            <span class="reaction" *ngFor="let reaction of message.Reaction.$values; let i = index" (click)="onRemoveReaction(message.id)">
      {{ reaction.reactionType }} <!-- Hiển thị emoji tương ứng -->
            </span>
          <span class="reaction-count" *ngIf="message.Reaction.$values.length > 1">
      +{{ message.Reaction.$values.length - 1 }}
          </span>
         </span>
        </div>

        <!-- Picker reactions -->
        <div *ngIf="activeReactionPickerIndex === i && !message.isDeleted" class="reaction-picker">
          <ng-container *ngFor="let reaction of availableReactions">
            <span class="reaction-option" (click)="onAddReaction(message.id, reaction)">
              {{ reaction }}
            </span>
          </ng-container>
        </div>

        <!-- Hiển thị trạng thái "Đã đọc" nếu đây là tin nhắn đã đọc cuối cùng -->
        <div *ngIf="!message.isDeleted && message.isRead && message.userId === currentUserId && i === messages.length - 1" class="message-status">
          Seen
        </div>
      </div>
    </div>

    <!-- Khung hiển thị tệp đính kèm (phía trên khung nhập tin nhắn) -->
    <div *ngIf="attachmentFile" class="attachment-preview">
      <ng-container [ngSwitch]="getAttachmentType(attachmentFile.name)">
        <!-- Hiển thị xem trước ảnh -->
        <img *ngSwitchCase="'image'" [src]="previewAttachmentUrl" alt="Preview image" class="attachment-preview-image" />

        <!-- Hiển thị xem trước video -->
        <video *ngSwitchCase="'video'" controls [src]="previewAttachmentUrl" class="attachment-preview-video"></video>

        <!-- Hiển thị xem trước âm thanh -->
        <audio *ngSwitchCase="'audio'" controls [src]="previewAttachmentUrl" class="attachment-preview-audio"></audio>

        <!-- Hiển thị file PDF -->
        <div *ngSwitchCase="'pdf'" class="attachment-file-preview">
          <i class="fas fa-file-pdf"></i>
          <span>{{ attachmentFile.name }}</span>
        </div>

        <!-- Hiển thị file DOCX -->
        <div *ngSwitchCase="'docx'" class="attachment-file-preview">
          <i class="fas fa-file-word"></i>
          <span>{{ attachmentFile.name }}</span>
        </div>

        <!-- Hiển thị các loại file khác -->
        <div *ngSwitchDefault class="attachment-file-preview">
          <i class="fas fa-file-alt"></i>
          <span>{{ attachmentFile.name }}</span>
        </div>
      </ng-container>
      <button (click)="removeAttachment()" class="remove-attachment-button">
        <i class="fas fa-trash-alt"></i>
      </button>
    </div>

    <!-- Vùng nhập tin nhắn -->
    <div class="message-input" *ngIf="recipientId">
      <!-- Reply Preview Section -->
      <div *ngIf="repliedToMessage" class="reply-preview">
        <p class="reply-preview-header">Replying to:</p>
        <div class="reply-preview-content">
          <span>{{ repliedToMessage.senderFullName }}:</span>
          <span [innerHTML]="repliedToMessage.message"></span>
        </div>
        <!-- Replace text with an icon -->
        <button class="cancel-reply" (click)="cancelReply()" aria-label="Cancel reply">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="emoji-picker">
        <i class="fas fa-smile" (click)="onEmojiClick()" title="Insert emoji"></i>
      </div>

      <input type="text" [(ngModel)]="newMessage" placeholder="Type a message..."
             (keydown.enter)="onSendMessage()" aria-label="Type a message" />

      <label for="fileInput" class="icon-button">
        <i class="fas fa-paperclip"></i>
      </label>
      <input type="file" id="fileInput" (change)="onFileSelected($event)" #fileInput style="display: none;" />

      <button (click)="onSendMessage()" [disabled]="!newMessage.trim() && !attachmentFile" class="icon-button">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- Template để hiển thị khi chưa chọn người nhận -->
  <ng-template #selectChatMessage>
    <div class="select-chat-message">
      <p>Please select a conversation or user to view the chat messages.</p>
    </div>
  </ng-template>
</div>
